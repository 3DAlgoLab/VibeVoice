# VibeVoice Web Demo

## Overview

The web demo (`demo/web/index.html`) provides a real-time text-to-speech interface for the VibeVoice model with streaming audio output.

## Structure

### Layout
- **Main container** (`.app-shell`): Centered card with max 960px width, rounded corners (20px), shadow
- **Header**: "VibeVoice-Realtime TTS Demo" title
- **Three main sections**:
  1. Text input and streaming preview
  2. Voice and generation controls
  3. Metrics and runtime logs

### CSS Architecture
- **CSS Variables**: Defined in `:root` for consistent theming
  - Backgrounds: `--bg` (#f5f7fc), `--surface` (#ffffff)
  - Accent: `--accent` (#5562ff), `--accent-strong` (#3f4dff)
  - Text: Primary and muted colors
  - Borders and shadows with consistent opacity

- **Component Classes**:
  - `.app-shell`: Main layout container
  - `.panel`, `.field`: Structural grouping
  - `.text-input`: Large textarea with focus states
  - `.select-control`, `.range-control`: Form elements
  - `.secondary-btn`: Outline-style buttons
  - `.metrics`: Data display area

## Features

### 1. Text Input & Streaming Preview
- **Large textarea** (min 140px, max 240px height) for entering text
- **Streaming preview**: Animates text input at 180 words/minute with blinking cursor
- **Helper text**: Explains that full text must be provided upfront with normalization recommendations

### 2. Voice & Generation Controls
- **Speaker dropdown**: Populated from `/config` endpoint with voice preset list
- **CFG slider**: 1.3–3.0 range, 0.05 steps (default 1.5)
- **Inference steps slider**: 5–20 range, 1 step increments (default 5)
- **Reset button**: Restores all controls to default values

### 3. Playback Controls
- **Start/Stop button**: Toggle audio generation with visual feedback (color change)
- **Save button**: Download generated audio as WAV file (disabled until audio available)

### 4. Real-time Metrics
- **Model Generated Audio**: Total audio generated by model in seconds
- **Audio Played**: Duration of audio played through browser
- Both metrics update during generation and playback

### 5. Runtime Logging System
- **Log output area**: Scrollable, monospace font, auto-scrolls
- **Timestamp format**: `YYYY-MM-DD HH:MM:SS.mmm`
- **Events logged**:
  - Backend request received
  - First audio chunk sent
  - Model progress updates
  - Generation errors
  - Client disconnections
  - Stream completion

### 6. Audio Streaming (WebSocket)
- **Connection**: WebSocket to `/stream` endpoint with query parameters
- **Parameters**: `text`, `cfg`, `steps`, `voice`
- **Audio format**: PCM16 (16-bit signed integers) at 24kHz sample rate
- **Buffer management**:
  - Pre-buffering: Waits for 0.1s of audio before playing
  - Rolling buffer: Maintains continuous playback stream
  - Silence detection: Stops after 4 consecutive silent frames

### 7. Audio Recording & Download
- **Chunk buffering**: All received audio chunks stored in memory
- **WAV generation**: Creates proper WAV header with metadata
  - RIFF header with correct file size
  - fmt chunk (16-bit PCM, mono/stereo, sample rate)
  - data chunk with PCM samples
- **Download filename**: `vibevoice_realtime_audio_[ISO-timestamp].wav`
- **URL cleanup**: Revoke object URLs on page unload to prevent memory leaks

## JavaScript Architecture

### Core Variables
```javascript
SAMPLE_RATE = 24_000
BUFFER_SIZE = 2048
PREBUFFER_SEC = 0.1
STREAMING_WPM = 180
```

### State Management
- `audioCtx`: Web AudioContext
- `scriptNode`: ScriptProcessorNode for audio processing
- `socket`: WebSocket connection
- `buffer`: Float32Array for audio chunk aggregation
- `isPlaying`: Playback state flag
- `recordedChunks`: Array of ArrayBuffer for WAV generation
- `playbackSamples`: Counter for elapsed time tracking

### Key Functions

**Audio Chain (`createAudioChain`)**:
- Creates AudioContext and ScriptProcessorNode
- Handles `onaudioprocess` callback for real-time audio rendering
- Manages pre-buffering and silence detection

**WebSocket Handling (`start`, `stop`)**:
- Constructs WebSocket URL with query parameters
- Parses incoming binary data (ArrayBuffer → Float32Array)
- Routes string messages to `handleLogMessage`

**Logging System (`appendLog`, `handleLogMessage`)**:
- Parses JSON log messages from backend
- Sorts entries by timestamp and sequence number
- Maintains max 400 log entries

**WAV Generation (`createWavBlob`)**:
- Builds 44-byte WAV header
- Combines all recorded chunks into single Int16Array
- Returns Blob with type `audio/wav`

### Event Listeners
- Text input: Updates streaming preview
- Range inputs: Update display values
- Start/Stop button: Toggle playback state
- Save button: Trigger WAV download
- Reset button: Restore defaults
- `beforeunload`: Cleanup resources

## Backend Integration

### Endpoints
- **GET /**: Serves `index.html`
- **GET /config**: Returns voice presets and default voice
- **WebSocket /stream**: Real-time audio streaming
  - Query params: `text`, `cfg`, `steps`, `voice`
  - Binary frames: PCM16 audio chunks
  - Text frames: JSON log messages

### Message Protocol
```json
{
  "type": "log",
  "event": "model_progress|backend_first_chunk_sent|...",
  "data": { ... },
  "timestamp": "YYYY-MM-DD HH:MM:SS.mmm"
}
```

## Responsive Design

**Mobile breakpoints** (`max-width: 720px`):
- Reduced padding (28px → 20px vertical)
- Full-width select controls
- Vertical stacked control row
- Full-width Start button with centered text

## Performance Considerations

1. **Memory management**: Revoke object URLs, clear log buffer at 400 entries
2. **Audio buffering**: Pre-buffering prevents playback gaps
3. **Silence detection**: Automatic stop after sustained silence
4. **Rolling window**: Log entries limited to prevent memory growth
5. **Cleanup on unload**: WebSocket close, audio context teardown
